# Maintainer: nl6720 <nl6720@archlinux.org>

pkgname='shim-signed-fedora'
pkgver='15.8'
pkgrel='1'
pkgdesc='Initial UEFI bootloader from Fedora that handles chaining to a trusted full bootloader under secure boot environments for x86_64, i386, and aarch64 architectures'
url='https://kojipkgs.fedoraproject.org/packages/shim'
arch=('any')
license=('BSD-2-Clause')
options=('!strip' '!debug')
install="${pkgname}.install"

# Fedora shim version and URLs
_SHIM_VERSION="15.8"
_SHIM_RELEASE="3"
_SHIM_URL="https://kojipkgs.fedoraproject.org/packages/shim/${_SHIM_VERSION}/${_SHIM_RELEASE}"
_SHIM_RPM="x86_64/shim-x64-${_SHIM_VERSION}-${_SHIM_RELEASE}.x86_64.rpm"
_SHIM32_RPM="x86_64/shim-ia32-${_SHIM_VERSION}-${_SHIM_RELEASE}.x86_64.rpm"
_SHIM_AA64_RPM="aarch64/shim-aa64-${_SHIM_VERSION}-${_SHIM_RELEASE}.aarch64.rpm"

# Directories for unpacking
_SHIM_DIR="${srcdir}/shim"
_SHIM32_DIR="${srcdir}/shim32"
_SHIMAA64_DIR="${srcdir}/shimaa64"

source=("http://kojipkgs.fedoraproject.org/packages/shim/${_SHIM_VERSION}/${_SHIM_RELEASE}/${_SHIM_RPM}"
        "http://kojipkgs.fedoraproject.org/packages/shim/${_SHIM_VERSION}/${_SHIM_RELEASE}/${_SHIM32_RPM}"
        "http://kojipkgs.fedoraproject.org/packages/shim/${_SHIM_VERSION}/${_SHIM_RELEASE}/${_SHIM_AA64_RPM}")

# Skip checksum verification for now
sha256sums=('SKIP' 'SKIP' 'SKIP')

prepare() {
    echo "Preparing shim files..."

    # Ensure directories exist
    mkdir -p "${_SHIM_DIR}" "${_SHIM32_DIR}" "${_SHIMAA64_DIR}"

    # Download RPM files (automatically handled by source array)
    echo "Unpacking RPM files..."
    bsdtar -C "${_SHIM_DIR}" -xf "${srcdir}/${_SHIM_RPM}"
    bsdtar -C "${_SHIM32_DIR}" -xf "${srcdir}/${_SHIM32_RPM}"
    bsdtar -C "${_SHIMAA64_DIR}" -xf "${srcdir}/${_SHIM_AA64_RPM}"
}

package() {
    echo "Installing shim files for x86_64, IA32, and AA64..."

    # Install shim files for x64, IA32, and AA64 architectures
    install -Dm0644 "${_SHIM_DIR}/boot/efi/EFI/fedora/{mmx64.efi,shimx64.efi}" "${pkgdir}/usr/share/${pkgname}/shimx64.efi"
    install -Dm0644 "${_SHIM_DIR}/boot/efi/EFI/fedora/shimx64.efi" "${pkgdir}/usr/share/${pkgname}/BOOTX64.efi"
    
    install -Dm0644 "${_SHIM32_DIR}/boot/efi/EFI/fedora/{mmia32.efi,shimia32.efi}" "${pkgdir}/usr/share/${pkgname}/shimia32.efi"
    install -Dm0644 "${_SHIM32_DIR}/boot/efi/EFI/fedora/shimia32.efi" "${pkgdir}/usr/share/${pkgname}/BOOTIA32.efi"
    
    install -Dm0644 "${_SHIMAA64_DIR}/boot/efi/EFI/fedora/{mmaa64.efi,shimaa64.efi}" "${pkgdir}/usr/share/${pkgname}/shimaa64.efi"
    install -Dm0644 "${_SHIMAA64_DIR}/boot/efi/EFI/fedora/shimaa64.efi" "${pkgdir}/usr/share/${pkgname}/BOOTAA64.efi"

}

# Clean up temporary directories after installation
cleanup() {
    rm -rf "${_SHIM_DIR}" "${_SHIM32_DIR}" "${_SHIMAA64_DIR}"
    echo "Cleanup complete."
}

# Hook cleanup after package installation
package() {
    # Existing package logic...
    cleanup
}

